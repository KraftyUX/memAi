name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test on Node.js ${{ matrix.node-version }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build

      - name: Check for linter configuration
        id: check-linter
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.yml" ] || grep -q "eslint" package.json; then
            echo "linter_exists=true" >> $GITHUB_OUTPUT
          else
            echo "linter_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run linting checks
        if: steps.check-linter.outputs.linter_exists == 'true'
        run: npm run lint
        continue-on-error: false
      
      - name: Verify package installation
        run: |
          echo "Verifying package.json integrity..."
          node -e "const pkg = require('./package.json'); console.log('✅ Package:', pkg.name, 'v' + pkg.version);"
          
          echo "Checking required dependencies..."
          node -e "const pkg = require('./package.json'); const deps = Object.keys(pkg.dependencies || {}); console.log('Dependencies:', deps.join(', ')); if (deps.length === 0) { console.warn('⚠️  No dependencies found'); }"
          
          echo "Verifying main entry point..."
          node -e "const pkg = require('./package.json'); const fs = require('fs'); if (!fs.existsSync(pkg.main)) { console.error('❌ Main file not found:', pkg.main); process.exit(1); } console.log('✅ Main entry point exists:', pkg.main);"
          
          echo "✅ Package installation verified"
      
      - name: Verify core module loading
        run: |
          echo "Testing core Memai class import..."
          node -e "import('./dist/src/memai.js').then(m => { if (!m.default) { console.error('❌ Default export not found'); process.exit(1); } console.log('✅ Memai class loaded successfully'); process.exit(0); }).catch(e => { console.error('❌ Failed to load Memai:', e.message); process.exit(1); });"
      
      - name: Test CLI command execution
        run: |
          echo "Creating test database..."
          node -e "import('./dist/src/memai.js').then(({ default: Memai }) => { const memai = new Memai('./.test-memai/test.db'); console.log('✅ Database initialized'); memai.close(); }).catch(e => { console.error('❌ Failed:', e.message); process.exit(1); });"
          
          echo "Testing basic operations..."
          node -e "import('./dist/src/memai.js').then(({ default: Memai }) => { const memai = new Memai('./.test-memai/test.db'); const id = memai.record({ category: 'test', action: 'CI test', context: 'Testing in CI' }); console.log('✅ Record created:', id); const stats = memai.getStats(); console.log('✅ Stats retrieved:', JSON.stringify(stats)); memai.close(); }).catch(e => { console.error('❌ Failed:', e.message); process.exit(1); });"
          
          echo "Cleaning up test database..."
          rm -rf ./.test-memai
          
          echo "✅ CLI commands validated"
      
      - name: Verify dashboard server
        run: |
          echo "Checking dashboard server file..."
          node -e "const fs = require('fs'); if (!fs.existsSync('./dist/src/server.js')) { console.error('❌ Dashboard server not found'); process.exit(1); } console.log('✅ Dashboard server file exists');"
          
          echo "Testing dashboard server import..."
          timeout 5 node dist/src/server.js > /dev/null 2>&1 || echo "✅ Dashboard server can be started (timed out as expected)"
      
      - name: Run tests
        run: npm test
